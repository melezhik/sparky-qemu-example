#!raku

use Sparky::JobApi;

directory "scm";

git-scm config()<repo>, %(
  to => "scm",
  branch => config()<branch>,
);

if tags()<stage> and tags()<stage> eq "child" {

  task-run "scm/tasks/setup-qemu-image", %(
    distro_url => config()<distro_url>,
  );

  bash "ls -lth {%*ENV<HOME>}/rocky-linux-distro";

  task-run "scm/tasks/run-qemu-box", %(
    iso => "{%*ENV<HOME>}/rocky-linux-distro/distro.qcow2",
    seed => "/tmp/init.iso"
  );

}
if tags()<stage> and tags()<stage> eq "child2" {
   say "hello from Sparky";
}
 
if !tags()<stage> { 
  task-run "scm/tasks/stop-qemu-box";
  # spawns a child job
  my $j = Sparky::JobApi.new;
  $j.queue({
    description => "run qemu box",
    tags => %(
      stage => "child",
    ),
  });

  say "queue spawned job, ",$j.info.raku;

  sleep(220);

  $j = Sparky::JobApi.new: :project<qemu_bootstrap>;
  
  $j.queue({
    description => "boostrap qemu box",
    tags => %(
      stage => "child2",
    ),
    sparrowdo => %(
       :bootstrap,
       :ssh_user => "admin",
       :ssh_port => 10022
    ),
  });

  say "queue spawned job, ",$j.info.raku;

  sleep(220);

  task-run "scm/tasks/stop-qemu-box";

}  
